version: 0.2

phases:
  install:
    commands:
      - echo Entered the install phase...
      - composer install
  build:
    commands:
      - echo Entered the build phase...
      - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
      - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
      - cp .env.$STAGE .env
      - zip -r plugin.zip ./ -x buildspec.yml .env.* .gitignore .git/\* assets/\* README.md
      - aws s3 cp plugin.zip s3://$PLUGIN_BUCKET/
      - aws s3 sync ./assets/ s3://$FRONT_BUCKET/plugin/
      - aws cloudfront create-invalidation --distribution-id $FRONT_DISTRIBUTION_ID --paths "/*"
